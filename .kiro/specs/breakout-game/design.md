# 設計書

## 概要

Raspberry Pi Pico 2 と HT16K33 8x8 LED マトリクスを使用したブロック崩しゲームの設計。既存のゲームアーキテクチャに従い、Game クラスを継承した BreakoutGame クラスとして実装する。

## アーキテクチャ

### システム構成

```
BreakoutGame (Game継承)
├── Ball (ボール管理)
├── Paddle (パドル管理)
├── Block (ブロック管理)
└── GameState (ゲーム状態管理)
```

### クラス階層

- `Game` (基底クラス - 既存)
  - `BreakoutGame` (新規実装)
    - `Ball` (内部クラス)
    - `Paddle` (内部クラス)
    - `Block` (内部クラス)

## コンポーネントと インターフェース

### BreakoutGame クラス

**責務:** ゲーム全体の制御、オブジェクト間の相互作用管理

**主要メソッド:**

- `initialize()`: ゲーム初期化（パドル、ボール、ブロック配置）
- `update()`: ゲームループ（入力処理、物理演算、衝突判定、描画）
- `finalize()`: ゲーム終了処理（画面クリア）
- `move_objects()`: オブジェクト位置更新、変化検出
- `check_collisions()`: 衝突判定処理
- `refresh()`: 画面描画更新

### Ball クラス（内部クラス）

**責務:** ボールの位置、速度、物理演算

**属性:**

- `x, y`: 現在位置（float）
- `vx, vy`: 速度ベクトル（float）
- `speed`: 基本速度

**メソッド:**

- `update()`: 位置更新
- `bounce_horizontal()`: 水平方向反射
- `bounce_vertical()`: 垂直方向反射
- `reset_position(paddle_x)`: パドル上に配置

### Paddle クラス（内部クラス）

**責務:** パドルの位置管理、入力処理

**属性:**

- `x`: 中央位置（int）
- `width`: パドル幅（3 ピクセル）
- `y`: 垂直位置（固定：Y=7、最下行）

**メソッド:**

- `move_left()`: 左移動
- `move_right()`: 右移動
- `get_positions()`: 3 ドットの座標リスト取得
- `get_bounce_angle(ball_x)`: ボール反射角度計算

### Block クラス（内部クラス）

**責務:** 個別ブロックの状態管理

**属性:**

- `x, y`: 位置
- `is_active`: 破壊状態

**メソッド:**

- `destroy()`: ブロック破壊
- `is_at_position(x, y)`: 位置判定

## データモデル

### ゲーム状態

```python
class GameState:
    PLAYING = "playing"
    GAME_OVER = "game_over"
    GAME_CLEAR = "game_clear"
```

### 座標系

- 原点: 左上 (0, 0)
- X 軸: 左 → 右 (0-7)
- Y 軸: 上 → 下(0-7)

### オブジェクト配置

```
Y=0  [B][B][B][B][B][B][B][B]  ← ブロック行1
Y=1  [B][B][B][B][B][B][B][B]  ← ブロック行2
Y=2  [B][B][B][B][B][B][B][B]  ← ブロック行3
Y=3  [ ][ ][ ][ ][ ][ ][ ][ ]
Y=4  [ ][ ][ ][o][ ][ ][ ][ ]  ← ボール例
Y=5  [ ][ ][ ][ ][ ][ ][ ][ ]
Y=6  [ ][ ][ ][ ][ ][ ][ ][ ]
Y=7  [ ][P][P][P][ ][ ][ ][ ]  ← パドル（最下行）
```

### 色定義

- ブロック: `LED_RED`
- パドル: `LED_GREEN`
- ボール: `LED_YELLOW` (オレンジに最も近い色)

## エラーハンドリング

### 境界チェック

- パドル移動時の画面端判定
- ボール移動時の壁衝突判定
- 配列アクセス時の範囲チェック

### ゲーム状態管理

- ゲームオーバー時の入力無効化
- 再開始時の状態リセット
- 異常状態からの復旧

## テスト戦略

### 単体テスト

1. **Ball クラステスト**

   - 位置更新の正確性
   - 壁反射の動作
   - 速度計算の検証

2. **Paddle クラステスト**

   - 移動範囲の制限
   - ボタン入力の応答
   - 境界条件の処理

3. **衝突判定テスト**
   - ボール-パドル衝突
   - ボール-ブロック衝突
   - ボール-壁衝突

### 統合テスト

1. **ゲームフローテスト**

   - 初期化 → プレイ → 終了の流れ
   - スコア更新の正確性
   - 画面更新の最適化

2. **ハードウェア統合テスト**
   - LED マトリクス表示
   - ボタン入力応答
   - 7 セグメント表示

### パフォーマンステスト

1. **フレームレートテスト**

   - 50FPS での安定動作
   - 画面更新頻度の最適化

2. **メモリ使用量テスト**
   - Pico 2 のメモリ制約内での動作

## 実装上の考慮事項

### 画面更新最適化

既存の FallingDotGame パターンに従い、オブジェクト位置変化時のみ画面更新を実行:

```python
def update(self):
    if not self.is_running:
        # ゲーム終了処理
        return

    # オブジェクト移動
    objects_moved = self.move_objects()

    # 衝突判定
    self.check_collisions()

    # 位置変化時のみ画面更新
    if objects_moved:
        self.refresh()
```

### 物理演算

- ボール速度: 適度な速度で視認可能
- 衝突判定: ピクセル単位の正確な判定
- パドル反射: 当たった位置による角度変化（オプション）

### スコア管理

7 セグメントディスプレイを使用:

- 破壊ブロック数をリアルタイム表示
- ゲーム終了時の最終スコア表示
- 表示範囲: 0-999（3 桁まで）

## パドル反射角度システム

### 反射角度の計算

パドルでの反射時、ボールが当たった位置によって反射角度を変化させる：

```
パドル位置: [左][中][右]  (3ドット)
反射角度:   -30° 0° +30°
```

### 実装方針

1. **角度変化**: パドルの左端で反射 → 左斜め上、右端で反射 → 右斜め上
2. **速度成分**: vx 成分を調整、vy 成分は上向きに固定
3. **ゲームバランス**: 全ブロック破壊可能な角度範囲を確保

### 角度計算式

```python
def get_bounce_angle(self, ball_x):
    # パドル中央からの相対位置 (-1, 0, +1)
    relative_pos = ball_x - self.x
    # 角度係数 (-0.5, 0, +0.5)
    angle_factor = relative_pos * 0.5
    return angle_factor
```
